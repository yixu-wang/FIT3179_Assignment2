{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "data": {
    "url": "https://raw.githubusercontent.com/yixu-wang/FIT3179_Assignment2/refs/heads/main/data/AlcoholConsumptionOverTime.csv"
  },
  "title": {
    "text": "Risky Alcohol Consumption over Time, by Age (Interpolated)",
    "fontSize": 15,
    "offset":20
  },
  "transform": [
    {"filter": "datum.Level == 'Risky'"},
    {"calculate": "replace(datum['Age group'],' to ','â€“')", "as": "Age"},
    {"calculate": "year(datum.Year)", "as": "ordYear"},
    {
      "window": [
        {"op": "first_value", "field": "Proportion", "as": "first_value"}
      ],
      "groupby": ["Age group"],
      "frame": [null, null]
    },
    {
      "calculate": "(datum.Proportion - datum.first_value) / datum.first_value * 100",
      "as": "relative_change"
    },
    {
      "calculate": "datum.relative_change > 0 ? datum.relative_change : 0",
      "as": "positive_change"
    },
    {
      "calculate": "datum.relative_change < 0 ? abs(datum.relative_change) : 0",
      "as": "negative_change"
    },
    {
      "calculate": "datum.positive_change >= 50 ? datum.positive_change - 50 : 0",
      "as": "large_positive_change"
    },
    {
      "calculate": "datum.negative_change >= 50 ? abs(datum.negative_change)-50 : 0",
      "as": "large_negative_change"
    },
    {
      "calculate": "(datum.Proportion - datum.first_value) / datum.first_value",
      "as": "relative_change_frac"
    }
  ],
  "spacing": {"row": 5},
  "facet": {
    "row": {
      "field": "Age",
      "type": "nominal",
      "header": {"labelAngle": 0, "title": "Age group"}
    }
  },
  "spec": {
    "layer": [
      {
        "mark": {"type": "area", "clip": true, "opacity": 1},
        "encoding": {
          "x": {"field": "Year", "type": "temporal", "axis": {"title": "Year"}},
          "y": {
            "field": "large_positive_change",
            "type": "quantitative",
            "axis": {"title": null},
            "scale": {"domain": [0, 50]}
          },
          "color": {"value": "#d73027"}
        }
      },
      {
        "mark": {"type": "area", "clip": true, "opacity": 0.4},
        "encoding": {
          "x": {"field": "Year", "type": "temporal"},
          "y": {"field": "positive_change", "type": "quantitative"},
          "color": {"value": "#d73027"},
          "tooltip": [
            {
              "field": "relative_change_frac",
              "title": "% change since 2007",
              "format": ".2%"
            },
            {"field": "ordYear", "title": "Year"}
          ]
        }
      },
      {
        "mark": {"type": "area", "clip": true, "opacity": 1},
        "encoding": {
          "x": {"field": "Year", "type": "temporal"},
          "y": {"field": "large_negative_change", "type": "quantitative"},
          "color": {"value": "#4575b4"}
        }
      },
      {
        "mark": {"type": "area", "clip": true, "opacity": 0},
        "encoding": {
          "x": {"field": "Year", "type": "temporal"},
          "y": {"field": "negative_change", "type": "quantitative"},
          "color": {
            "field": "relative_change",
            "scale": {
              "type": "quantize",
              "range": ["#4575b4", "#b4c8e1", "#fb9a99", "#d73027"],
              "domain": [-100, 100]
            },
            "title": ["% Change in", "Proportion", "since 2007"],
            "legend": {
              "values": [-100, -100, -50, 0, 50, 100],
              "titlePadding": 10
            }
          }
        }
      },
      {
        "mark": {"type": "area", "clip": true, "opacity": 0.4},
        "encoding": {
          "x": {"field": "Year", "type": "temporal"},
          "y": {"field": "negative_change", "type": "quantitative"},
          "color": {"value": "#4575b4"},
          "tooltip": [
            {
              "field": "relative_change_frac",
              "title": "% change since 2007",
              "format": ".2%"
            },
            {"field": "ordYear", "title": "Year"}
          ]
        }
      }
    ]
  }
}